name: Nix Configuration Check

on:
  push:
    branches: [ main, nightly ]
  pull_request:
    branches: [ main, nightly ]
  workflow_dispatch:

jobs:
  check-nix-config:
    runs-on: ubuntu-latest
    name: Check Nix Configuration
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: Check flake
        run: nix flake check --all-systems
        
      - name: Check if configurations build (dry-run)
        run: |
          echo "Checking megabookpro configuration..."
          nix build .#darwinConfigurations.megabookpro.system --dry-run
          
          echo "Checking oldmbpro configuration..."
          nix build .#darwinConfigurations.oldmbpro.system --dry-run
        
      - name: Check home-manager configurations
        run: |
          echo "Checking home-manager configuration..."
          nix build .#darwinConfigurations.megabookpro.config.home-manager.users.seth.home.activationPackage --dry-run
          
      - name: Format check (if nixfmt is available)
        run: |
          if command -v nixfmt &> /dev/null; then
            echo "Checking formatting..."
            find . -name "*.nix" -not -path "./.git/*" | xargs nixfmt --check
          else
            echo "nixfmt not available, skipping format check"
          fi
        continue-on-error: true
        
      - name: Check for common issues
        run: |
          echo "Checking for common Nix issues..."
          
          # Check for missing semicolons in attribute sets
          if grep -r "^\s*[a-zA-Z_][a-zA-Z0-9_]*\s*=" --include="*.nix" . | grep -v ";\s*$" | grep -v "//"; then
            echo "Warning: Found potential missing semicolons in Nix files"
          fi
          
          # Check for unused inputs
          declared_inputs=$(grep -A 20 "inputs = {" flake.nix | grep -E "^\s*[a-zA-Z0-9_-]+\s*=" | sed 's/^\s*//' | cut -d' ' -f1 | sort)
          used_inputs=$(find config/nix -name "*.nix" -exec grep -ho "inputs\.[a-zA-Z0-9_-]*" {} \; | sed 's/inputs\.//' | sort -u)
          
          echo "Declared inputs: $declared_inputs"
          echo "Used inputs: $used_inputs"
        continue-on-error: true

  check-nix-config-macos:
    runs-on: macos-latest
    name: Check Nix Configuration (macOS)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            
      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        
      - name: Check flake on macOS
        run: nix flake check
        
      - name: Build darwin configuration (dry-run)
        run: |
          echo "Building megabookpro configuration (dry-run)..."
          nix build .#darwinConfigurations.megabookpro.system --dry-run