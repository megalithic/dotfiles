#!/usr/bin/env bash
set -euo pipefail

CA_URL="https://vault.platform.launchdeck.internal:8200/v1/pki/ca/pem"
CA_FILE="/tmp/vault-ca.pem"
CA_NAME="C Spire LaunchDeck Vault CA"

echo "ğŸ¦Š Firefox-only certificate trust setup"
echo "========================================"
echo

# Download CA if not present
if [[ ! -f "$CA_FILE" ]]; then
    echo "ğŸ“¥ Downloading CA certificate..."
    curl -sk "$CA_URL" -o "$CA_FILE"
fi

# Find Firefox profiles
FIREFOX_PROFILES=$(find "$HOME/Library/Application Support/Firefox/Profiles" -maxdepth 1 -type d -name "*.default*" 2>/dev/null || true)

if [[ -z "$FIREFOX_PROFILES" ]]; then
    echo "âŒ No Firefox profiles found"
    exit 1
fi

for profile in $FIREFOX_PROFILES; do
    profile_name=$(basename "$profile")
    echo "ğŸ“¦ Adding to profile: $profile_name"
    certutil -A -n "$CA_NAME" -t "C,," -i "$CA_FILE" -d "sql:$profile" 2>/dev/null && \
        echo "   âœ… Added successfully" || \
        echo "   â„¹ï¸  May already exist"
done

echo
echo "âœ… Firefox setup complete! Restart Firefox to take effect."
