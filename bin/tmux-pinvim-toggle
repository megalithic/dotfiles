#!/usr/bin/env bash
# Toggle pinvim pane into/out of current tmux window
#
# Socket pattern: /tmp/pi-{session}-{window}.sock
#
# Behavior:
# - If pinvim socket exists for current window: focus its pane
# - If pinvim is a split in current window: break it out to "agent" window
# - If pinvim running in another window: join from there
# - If no pinvim anywhere: start it in a new right split

set -euo pipefail

# Capture pinvim path now (script runs with proper PATH, but tmux split-window uses /bin/sh)
PINVIM_PATH=$(which pinvim)

SESSION=$(tmux display-message -p '#{session_name}')
WINDOW_IDX=$(tmux display-message -p '#{window_index}')
CURRENT_WINDOW=$(tmux display-message -p '#{window_name}')

# Agent window name (where pinvim goes when broken out)
AGENT_WINDOW="agent"

# Socket for current window
CURRENT_SOCKET="/tmp/pi-${SESSION}-${WINDOW_IDX}.sock"

# If we're in the agent window, switch back to last window
if [[ "$CURRENT_WINDOW" == "$AGENT_WINDOW" ]]; then
  tmux last-window
  exit 0
fi

# Check if a socket exists for a given window index
socket_exists_for_window() {
  local win_idx="$1"
  [[ -S "/tmp/pi-${SESSION}-${win_idx}.sock" ]]
}

# Find window index that has a pinvim socket (excluding current window)
find_pinvim_window() {
  local win_idx
  for win_idx in $(tmux list-windows -F '#{window_index}'); do
    if [[ "$win_idx" != "$WINDOW_IDX" ]] && socket_exists_for_window "$win_idx"; then
      echo "$win_idx"
      return 0
    fi
  done
  return 1
}

# Find pinvim pane in current window (check all panes for pi process)
find_pinvim_pane_in_current_window() {
  local pane_count
  pane_count=$(tmux list-panes | wc -l | tr -d ' ')
  
  # Only check if there's more than one pane
  if [[ "$pane_count" -lt 2 ]]; then
    return 1
  fi
  
  local pane_info pane_id pane_pid
  for pane_info in $(tmux list-panes -F '#{pane_id}:#{pane_pid}'); do
    pane_id="${pane_info%%:*}"
    pane_pid="${pane_info##*:}"
    
    # Check if this pane's shell has a pi child process
    if ps -o ppid=,comm= -ax 2>/dev/null | rg -q "^\s*${pane_pid}\s+pi$"; then
      echo "$pane_id"
      return 0
    fi
  done
  return 1
}

# Get window index for agent window (returns empty if not found)
get_agent_window_index() {
  tmux list-windows -F '#{window_index}:#{window_name}' | rg ":${AGENT_WINDOW}\$" | cut -d: -f1
}

# Main logic
main() {
  # Case 1: Pinvim socket exists for current window and is a split → focus it
  if [[ -S "$CURRENT_SOCKET" ]]; then
    if pinvim_pane=$(find_pinvim_pane_in_current_window); then
      tmux select-pane -t "$pinvim_pane"
      exit 0
    fi
  fi
  
  # Case 2: Pinvim is a split in current window → break it out to agent window
  if pinvim_pane=$(find_pinvim_pane_in_current_window); then
    tmux break-pane -d -s "$pinvim_pane" -n "$AGENT_WINDOW"
    exit 0
  fi
  
  # Case 3: Agent window exists → join pane from there
  agent_idx=$(get_agent_window_index || true)
  if [[ -n "$agent_idx" ]]; then
    tmux join-pane -h -s "${agent_idx}.1" -l 40%
    exit 0
  fi
  
  # Case 4: Pinvim running in another window → join from there
  if other_win=$(find_pinvim_window); then
    # Find the pane with pinvim in that window
    local pane_info pane_id pane_pid
    for pane_info in $(tmux list-panes -t "$other_win" -F '#{pane_id}:#{pane_pid}'); do
      pane_id="${pane_info%%:*}"
      pane_pid="${pane_info##*:}"
      
      if ps -o ppid=,comm= -ax 2>/dev/null | rg -q "^\s*${pane_pid}\s+pi$"; then
        tmux join-pane -h -s "$pane_id" -l 40%
        exit 0
      fi
    done
    # Fallback: just join first pane from that window
    tmux join-pane -h -s "${other_win}.1" -l 40%
    exit 0
  fi
  
  # Case 5: No pinvim running → start it in a new right split
  tmux split-window -h -l 40% "$PINVIM_PATH"
}

main "$@"
