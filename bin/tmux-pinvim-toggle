#!/usr/bin/env bash
# Toggle pisock/pinvim pane into/out of current tmux window
#
# SOCKET CONFIGURATION (nix is single source of truth):
#   Pattern: /tmp/pi-{session}.sock (one socket per tmux session)
#   Defined in: ~/.dotfiles/home/programs/ai/pi-coding-agent/default.nix
#
# Behavior:
# - If in agent window: switch back to last window
# - If pinvim pane exists in current window: break it out to "agent" window
# - If agent window exists: join pane from there (40% split)
# - If no agent anywhere: start pinvim in a new right split

set -euo pipefail

# Socket configuration (matches nix config)
SOCKET_DIR="/tmp"
SOCKET_PREFIX="pi"

# Capture pinvim path now (script runs with proper PATH, but tmux split-window uses /bin/sh)
PINVIM_PATH=$(which pinvim)

SESSION=$(tmux display-message -p '#{session_name}')
WINDOW_IDX=$(tmux display-message -p '#{window_index}')
CURRENT_WINDOW=$(tmux display-message -p '#{window_name}')

# Agent window name (where pinvim goes when broken out)
AGENT_WINDOW="agent"

# Socket for this session
SESSION_SOCKET="${SOCKET_DIR}/${SOCKET_PREFIX}-${SESSION}.sock"

# If we're in the agent window, switch back to last window
if [[ "$CURRENT_WINDOW" == "$AGENT_WINDOW" ]]; then
  tmux last-window
  exit 0
fi

# Find pinvim pane in current window (check all panes for pi process)
find_pinvim_pane_in_current_window() {
  local pane_count
  pane_count=$(tmux list-panes | wc -l | tr -d ' ')
  
  # Only check if there's more than one pane
  if [[ "$pane_count" -lt 2 ]]; then
    return 1
  fi
  
  local pane_info pane_id pane_pid
  for pane_info in $(tmux list-panes -F '#{pane_id}:#{pane_pid}'); do
    pane_id="${pane_info%%:*}"
    pane_pid="${pane_info##*:}"
    
    # Check if this pane's shell has a pi child process
    if ps -o ppid=,comm= -ax 2>/dev/null | rg -q "^\s*${pane_pid}\s+pi$"; then
      echo "$pane_id"
      return 0
    fi
  done
  return 1
}

# Get window index for agent window (returns empty if not found)
get_agent_window_index() {
  tmux list-windows -F '#{window_index}:#{window_name}' | rg ":${AGENT_WINDOW}\$" | cut -d: -f1
}

# Find any window with a pi process (for fallback)
find_any_pinvim_window() {
  local win_idx
  for win_idx in $(tmux list-windows -F '#{window_index}'); do
    if [[ "$win_idx" == "$WINDOW_IDX" ]]; then
      continue
    fi
    
    local pane_info pane_pid
    for pane_info in $(tmux list-panes -t "$win_idx" -F '#{pane_pid}'); do
      if ps -o ppid=,comm= -ax 2>/dev/null | rg -q "^\s*${pane_info}\s+pi$"; then
        echo "$win_idx"
        return 0
      fi
    done
  done
  return 1
}

# Main logic
main() {
  # Case 1: Pinvim is a split in current window → break it out to agent window
  if pinvim_pane=$(find_pinvim_pane_in_current_window); then
    tmux break-pane -d -s "$pinvim_pane" -n "$AGENT_WINDOW"
    exit 0
  fi
  
  # Case 2: Agent window exists → join pane from there
  agent_idx=$(get_agent_window_index || true)
  if [[ -n "$agent_idx" ]]; then
    tmux join-pane -h -s "${agent_idx}.1" -l 40%
    exit 0
  fi
  
  # Case 3: Pinvim running in another window → join from there
  if other_win=$(find_any_pinvim_window); then
    # Find the pane with pinvim in that window
    local pane_info pane_id pane_pid
    for pane_info in $(tmux list-panes -t "$other_win" -F '#{pane_id}:#{pane_pid}'); do
      pane_id="${pane_info%%:*}"
      pane_pid="${pane_info##*:}"
      
      if ps -o ppid=,comm= -ax 2>/dev/null | rg -q "^\s*${pane_pid}\s+pi$"; then
        tmux join-pane -h -s "$pane_id" -l 40%
        exit 0
      fi
    done
    # Fallback: just join first pane from that window
    tmux join-pane -h -s "${other_win}.1" -l 40%
    exit 0
  fi
  
  # Case 4: No pinvim running → start it in a new right split
  tmux split-window -h -l 40% "$PINVIM_PATH"
}

main "$@"
