#!/usr/bin/env bash

set -euo pipefail

[[ -f "$ZDOTDIR/lib/helpers.zsh" ]] && source "$ZDOTDIR/lib/helpers.zsh"

# clean_exit defined in helpers.zsh
# trap 'clean_exit $? $LINENO' EXIT

# -- friendly help if -h option given
function __help() {
  printf -- "Usage: %s [options] [SESSION_NAME]\n" "duc"
  printf -- "\n"
  printf -- "Options:\n"
  printf -- "  -h  This help text you're presently reading üòÑ\n"
  printf -- "  -a  Immediately attach to the created session\n"
  printf -- "\n"
  printf -- "Examples:\n"
  printf -- "  duc processes htop\n"
  printf -- "  duc weechat weechat\n"
  printf -- "  duc logs dev logs -f\n"
  printf -- "\n"
  printf -- "#protip:\n"
  printf -- "  <C-\\> to detach from active session\n"
  printf -- "\n"

  exit 0
}

IMMEDIATELY_ATTACH="true"

while getopts "hb" OPTION; do
  case $OPTION in
    b)
      IMMEDIATELY_ATTACH="false"
      ;;

    h)
      __help
      ;;

    \?)
      # NOTE: this covers the case where an optarg may not be provided
      # and will exit errored
      echo "Invalid Option: -$OPTARG" 1>&2
      exit 1
      ;;
  esac
done
shift "$((OPTIND - 1))"

# -- this is our given session_name param, sans options
session_name="${1:-}"
shift

cmd="${*:-}"

# -- try to change to an existing session; otherwise, create a new one
function try_session() {
  local session="$1"
  local session_create_opt="-c"

  # no session given; bail out
  if [[ -z "$session" ]]; then
    exit 0
  fi

  if [[ $IMMEDIATELY_ATTACH == "false" ]]; then
    session_create_opt="-n"
  fi

  if abduco -l | grep -q "$session"; then
    echo "session $session exists"
    abduco -a "$session"
  elif [[ -n "$cmd" ]]; then
    # FIXME: why is this not working? `$cmd` isn't running :sadpanda:
    echo "session $session DOES NOT exist; creating with command $cmd.."
    command abduco "$session_create_opt" "$session" "$cmd"
  else
    echo "could not attach to or create new session named $session; exiting.."
    exit 1
  fi

  exit 0
}

function fuzzy_find() {
  # -- prepare for fuzzy-finding!!
  # REF: finds the attached session abduco -l | awk '$1 ~ /^\*/'
  sessions_list=$(abduco | tail -n+2 | cut -f 4)
  # sessions_count=$(echo "$sessions_list" | wc -l | sed -e 's/^[[:space:]]*//')

  fzf_prompt_text="Ôíê attach to session ÔÅî "

  # -- get our session from fzf (grabs the the active pane from each session as preview, too!)
  selected="$(echo "$sessions_list" | fzf --reverse --border=none --padding="1" --preview-window="hidden" --prompt="$fzf_prompt_text" --bind="enter:replace-query+print-query")"
  try_session "$selected"
}

# -- if we pass in a session_name: attach/switch to it or, create new session
if [[ -n "$session_name" ]]; then
  try_session "$session_name"
  exit 0
fi

# -- no session given so invoke fzf instead
fuzzy_find
