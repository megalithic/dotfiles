#!/bin/bash

[[ -f "$XDG_CONFIG_HOME/zsh/lib/helpers.zsh" ]] && source "$XDG_CONFIG_HOME/zsh/lib/helpers.zsh"

set -euo pipefail

# -- set some useful vars for executable info:
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename ${__file} .sh)"
__root="$(cd "$(dirname "${__dir}")" && pwd)"
# shellcheck disable=SC2034,SC2015
__invocation="$(printf %q "${__file}")$( (($#)) && printf ' %q' "$@" || true)"

elixirls_path="$XDG_DATA_HOME/lsp/elixir-ls"

do_install() {
  log "downloading and installing to $elixirls_path"
  curl -fLO https://github.com/elixir-lsp/elixir-ls/releases/latest/download/elixir-ls.zip \
    && unzip -o elixir-ls.zip -d "$elixirls_path" \
    && chmod +x "$elixirls_path/language_server.sh" \
    && echo "" \
    && (rm elixir-ls.zip && log_ok "removed $HOME/elixir-ls.zip") \
    && log_ok "finished downloading and installing elixir-ls to $elixirls_path" \
    || exit 1
  }

  read -p "$(tput bold)$(tput setaf 5)[?] download and install latest elixir-ls (Y/n)?$(tput sgr 0) " yn;
  case $yn in
    [Yy]* )
      do_install || exit 1
      ;;
    "" )
      do_install || exit 1
      ;;
    [Nn]* )
      log_warn "opted out of elixir-ls install"
      ;;
    * )
      log_warn "please answer [y]es or [n]o."
      exec $__invocation
      ;;
  esac
