#!/usr/bin/env bash

# Ensure UTF-8 encoding for unicode character support
export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

source "$HOME/bin/helpers"

if [[ $# -ne 1 ]]; then
  >&2 echo "usage: $0 FILENAME[:LINENO][:IGNORED]"
  exit 1
fi

file=${1/#\~\//$HOME/}

center=0
if [[ ! -r $file ]]; then
  if [[ $file =~ ^(.+):([0-9]+)\ *$ ]] && [[ -r ${BASH_REMATCH[1]} ]]; then
    file=${BASH_REMATCH[1]}
    center=${BASH_REMATCH[2]}
  elif [[ $file =~ ^(.+):([0-9]+):[0-9]+\ *$ ]] && [[ -r ${BASH_REMATCH[1]} ]]; then
    file=${BASH_REMATCH[1]}
    center=${BASH_REMATCH[2]}
  fi
fi

dim=${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}
if [[ $dim == x ]]; then
  dim=$(stty size </dev/tty | awk '{print $2 "x" $1}')
elif ! [[ $KITTY_WINDOW_ID ]] && ((FZF_PREVIEW_TOP + FZF_PREVIEW_LINES == $(stty size </dev/tty | awk '{print $1}'))); then
  # Avoid scrolling issue when the Sixel image touches the bottom of the screen
  # * https://github.com/junegunn/fzf/issues/2544
  dim=${FZF_PREVIEW_COLUMNS}x$((FZF_PREVIEW_LINES - 1))
fi

type=$(file --brief --dereference --mime -- "$file")

if [[ "$1" == "--process" ]]; then
  pid="$2"

  ps -p "$pid" -o pid,ppid,user,%cpu,%mem,vsz,rss,tty,stat,start,time,command 2>/dev/null | tail -n +2 | while IFS= read -r line; do
    echo "PID:       $(echo "$line" | awk '{print $1}')"
    echo "PPID:      $(echo "$line" | awk '{print $2}')"
    echo "User:      $(echo "$line" | awk '{print $3}')"
    echo "CPU %:     $(echo "$line" | awk '{print $4}')"
    echo "Memory %:  $(echo "$line" | awk '{print $5}')"
    echo "VSZ:       $(echo "$line" | awk '{print $6}') KB"
    echo "RSS:       $(echo "$line" | awk '{print $7}') KB"
    echo "TTY:       $(echo "$line" | awk '{print $8}')"
    echo "Stat:      $(echo "$line" | awk '{print $9}')"
    echo "Start:     $(echo "$line" | awk '{print $10}')"
    echo "Time:      $(echo "$line" | awk '{print $11}')"
    echo "Command:"
    echo "  $(echo "$line" | awk '{for(i=12;i<=NF;i++) printf "%s ", $i; print ""}')"
  done
  if lsof -p "$pid" >/dev/null 2>&1; then
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Open Files:"
    lsof -p "$pid" 2>/dev/null | tail -n +2 | head -20
  fi

  exit 0
fi

handle_image() {
  case "$1" in
  image/*)
    if [[ $KITTY_WINDOW_ID ]] || [[ $GHOSTTY_RESOURCES_DIR ]] && command -v kitten >/dev/null; then
      # 1. 'memory' is the fastest option but if you want the image to be scrollable,
      #    you have to use 'stream'.
      #
      # 2. The last line of the output is the ANSI reset code without newline.
      #    This confuses fzf and makes it render scroll offset indicator.
      #    So we remove the last line and append the reset code to its previous line.
      # kitten icat --clear --transfer-mode=memory --unicode-placeholder --stdin=no --place="$dim@0x0" "$file" | sed '$d' | sed $'$s/$/\e[m/'

      # local width="${FZF_PREVIEW_COLUMNS:-80}"
      # local height="${FZF_PREVIEW_LINES:-40}"
      # kitty icat --clear --transfer-mode=file --stdin=no --place=200x200@0x0 "$2"

      kitty icat --clear --transfer-mode=memory --unicode-placeholder --stdin=no --place="$dim@0x0" "$file" | sed '$d' | sed $'$s/$/\e[m/'
    # 2. Use chafa with Sixel output
    elif command -v chafa >/dev/null; then
      chafa -s "$dim" "$file"
      # Add a new line character so that fzf can display multiple images in the preview window
      echo
    # 3. If chafa is not found but imgcat is available, use it on iTerm2
    elif command -v imgcat >/dev/null; then
      # NOTE: We should use https://iterm2.com/utilities/it2check to check if the
      # user is running iTerm2. But for the sake of simplicity, we just assume
      # that's the case here.
      imgcat -W "${dim%%x*}" -H "${dim##*x}" "$file"
    # 4. Cannot find any suitable method to preview the image
    else
      file "$file"
    fi
    ;;
  *) exiftool -All "$2" ;;
  esac
}

handle_text() {
  local input="$1"
  case "$input" in
  *.md) CLICOLOR_FORCE=1 COLORTERM=truecolor glow -p -s dark -w 150 "$input" ;;
  *.htm | *.html) links -dump "$input" ;;
  # *.json | *.jsonc | *.json5) jq --color-output '"$@"' <<<"$input" ;;
  *)
    # bat --color=always --pager=never --highlight-line="${center:-0}" -- "$file"
    bat --style="${BAT_STYLE:-numbers}" --theme="${BAT_THEME:-base16}" --color=always --pager=never --highlight-line="${center:-0}" -- "$file"
    # bat --theme=base16 --color=always --style=numbers --line-range :300 "$input"
    ;;
  esac
}

test -d "$HOME/.cache/fzf" || mkdir -p "$HOME/.cache/fzf"
cache="$HOME/.cache/fzf/thumbnail.$(stat "$(readlink -f "$1")" | sha256sum | awk '{print $1}')"
mime="$(file --mime-type -b "$1")"
fullpath="$(printf "%s\n" "$(readlink -f "$1")")"
width="${FZF_PREVIEW_COLUMNS:-$(tput cols)}"

# Alternative characters: â”€ (box drawing), â” (heavy), â• (double), â– (lower block), â€¾ (overline), ðŸ®ðŸ®‘ðŸ®â–â€¾â–â– â”€ â–„â”€â–-_â€¾
printf "â–‘ î˜Ž  -> $yellow$mime$reset\n"
printf "â–‘ ó°™…  -> $blue$fullpath$reset\n"
printf "$dark_grey%${width}s\n$reset" | sed 's/ /â€¾/g'
printf "\n"

case "$1" in
*.md) handle_text "$1" ;;
*.htm | *.html) handle_text "$1" ;;
*.tgz | *.tar.gz) tar tzf "$1" ;;
*.tar.bz2 | *.tbz2) tar tjf "$1" ;;
*.tar.txz | *.txz) xz --list "$1" ;;
*.tar) tar tf "$1" ;;
*.zip | *.jar | *.war | *.ear | *.oxt) unzip -l "$1" ;;
*.rar) unrar l "$1" ;;
*.7z) 7z l "$1" ;;
*.[1-8]) man "$1" | col -b ;;
*.o) nm "$1" ;;
*.torrent) transmission-show "$1" ;;
*.iso) iso-info --no-header -l "$1" ;;
*.odt | *.ods | *.odp | *.sxw) odt2txt "$1" ;;
*.doc) catdoc "$1" ;;
*.docx) docx2txt "$1" - ;;
*.xls | *.xlsx) ssconvert --export-type=Gnumeric_stf:stf_csv "$1" "fd://1" | batorcat --language=csv ;;
*.wav | *.mp3 | *.flac | *.m4a | *.wma | *.ape | *.ac3 | *.og[agx] | *.spx | *.opus | *.as[fx] | *.mka) exiftool "$1" ;;
*.svg)
  [ ! -f "${cache}.jpg" ] && convert "$1" "${cache}.jpg"
  handle_image "image/*" "${cache}.jpg"
  ;;
*)
  # [mime-type matchers] --------------------------------------------------------------------------
  case "$mime" in
  text/*) handle_text "$1" ;;
  inode/directory) eza -ahFT -L=1 --color=always --icons=always --sort=size --group-directories-first "$1" ;;
  inode/symlink) printf "symlink to: \e[34m%s\e[0m." "$(readlink "$1")" ;;
  application/json)
    handle_text "$1"
    ;;
    # case "$mime" in
    # *.json | *.jsonc | *.json5) jq --color-output '"$@"' <<<"$1" ;;
    # *.toml | *.tml) yq --color-output <"$1" ;;
    # *.yaml | *.yml) yq --color-output <"$1" ;;
    # esac
    # ;;
  # application/yaml) yq --color-output <"$1" ;;
  # application/x-bittorrent) transmission-show --unsorted "$1" ;;
  application/x-executable | application/x-pie-executable | application/x-sharedlib) readelf --wide --demangle=auto --all "$1" ;;
  application/zip) atool --list "$1" ;;
  application/x-x509-ca-cert) openssl x509 -text -noout -in "$1" ;;
  application/pdf)
    pdftoppm -jpeg -f 1 -singlefile "$1" "$cache"
    handle_image "image/*" "$cache.jpg"
    ;;
  application/*) handle_text "$1" ;;
  image/*) handle_image "$mime" "$1" ;;
  video/*)
    ffmpegthumbnailer -i "$1" -o "${cache}.jpg" -s 200
    handle_image "image/*" "${cache}.jpg"
    ;;
  font/* | application/vnd.ms-opentype)
    echo "previewing font.."
    preview_font "$1"
    ;;
  *)
    log_error "oops; no handler found"
    exit 1
    ;;
  esac
  ;;
esac
