#!/usr/bin/env bash
# Toggle pi agent pane into/out of current tmux window
#
# Model:
#   - Agent window ("agent") is the canonical home for pinvim
#   - FROM nvim: join-pane from agent into current window (40% split)
#   - FROM shell: just switch to agent window (no split)
#   - Toggle back reverses the action (close split OR switch to prev window)
#
# Socket: /tmp/pi-{session}-{window}.sock (one per tmux window)

set -euo pipefail

SESSION=$(tmux display-message -p '#{session_name}')
CURRENT_WINDOW=$(tmux display-message -p '#{window_name}')
CURRENT_WINDOW_IDX=$(tmux display-message -p '#{window_index}')
PANE_COUNT=$(tmux list-panes | wc -l | tr -d ' ')

AGENT_WINDOW="agent"
PINVIM_PATH="pinvim"

# State file to track how we got to agent (split vs direct)
STATE_FILE="/tmp/tmux-agent-toggle-${SESSION}"

# Get socket path for a specific window
get_socket_path() {
  local win_idx="${1:-$CURRENT_WINDOW_IDX}"
  echo "/tmp/pi-${SESSION}-${win_idx}.sock"
}

# Check if agent window exists
agent_window_exists() {
  tmux list-windows -F '#{window_name}' | rg -qx "$AGENT_WINDOW"
}

# Get agent window index
get_agent_window_idx() {
  tmux list-windows -F '#{window_index}:#{window_name}' | rg ":${AGENT_WINDOW}$" | cut -d: -f1
}

# Check if nvim/vim is running in current pane
is_nvim_running() {
  local cmd
  cmd=$(tmux display-message -p '#{pane_current_command}')
  [[ "$cmd" == "nvim" || "$cmd" == "vim" ]]
}

# Check if a window index still exists
window_exists() {
  local win_idx="$1"
  tmux list-windows -F '#{window_index}' | rg -qx "$win_idx"
}

# Check if a pane in current window is linked from agent (has pi process)
locate_agent_pane_in_current() {
  [[ "$PANE_COUNT" -lt 2 ]] && return 1
  local pane_id pane_pid
  while IFS=: read -r pane_id pane_pid; do
    if pgrep -P "$pane_pid" -x pi >/dev/null 2>&1; then
      echo "$pane_id"
      return 0
    fi
  done < <(tmux list-panes -F '#{pane_id}:#{pane_pid}')
  return 1
}

# Locate any window with pinvim running (by checking for pi process)
locate_pinvim_window() {
  local win_idx pane_pid
  for win_idx in $(tmux list-windows -F '#{window_index}'); do
    for pane_pid in $(tmux list-panes -t "$win_idx" -F '#{pane_pid}'); do
      if pgrep -P "$pane_pid" -x pi >/dev/null 2>&1; then
        echo "$win_idx"
        return 0
      fi
    done
  done
  return 1
}

# Move window to last position and rename to "agent"
move_to_agent_window() {
  local src_win="$1"
  local last_idx
  last_idx=$(tmux list-windows -F '#{window_index}' | sort -n | tail -1)
  tmux move-window -s "$src_win" -t "$((last_idx + 1))"
  tmux rename-window -t "$((last_idx + 1))" "$AGENT_WINDOW"
}

# Create new agent window with pinvim at last position
create_agent_window() {
  local last_idx
  last_idx=$(tmux list-windows -F '#{window_index}' | sort -n | tail -1)
  tmux new-window -d -t "$((last_idx + 1))" -n "$AGENT_WINDOW" "$PINVIM_PATH"
}

save_state() { echo "$1" > "$STATE_FILE"; }
read_state() { [[ -f "$STATE_FILE" ]] && cat "$STATE_FILE" || echo ""; }
clear_state() { : > "$STATE_FILE"; }  # Truncate instead of delete

main() {
  # If we are IN the agent window -> toggle OUT
  if [[ "$CURRENT_WINDOW" == "$AGENT_WINDOW" ]]; then
    local state
    state=$(read_state)
    clear_state
    if [[ "$state" == "split" ]]; then
      tmux last-window
    elif [[ "$state" == direct:* ]]; then
      local prev_win="${state#direct:}"
      if window_exists "$prev_win"; then
        tmux select-window -t "$prev_win"
      fi
    else
      tmux last-window
    fi
    exit 0
  fi

  # If agent pane is already split into current window -> TOGGLE OUT
  if agent_pane=$(locate_agent_pane_in_current); then
    clear_state
    local current_pane stay_pane
    current_pane=$(tmux display-message -p '#{pane_id}')
    if [[ "$current_pane" == "$agent_pane" ]]; then
      stay_pane=$(tmux list-panes -F '#{pane_id}' | while read p; do [[ "$p" != "$agent_pane" ]] && echo "$p" && break; done)
    else
      stay_pane="$current_pane"
    fi
    tmux break-pane -d -s "$agent_pane" -n "$AGENT_WINDOW"
    move_to_agent_window "$(get_agent_window_idx)"
    tmux move-window -r
    tmux select-pane -t "$stay_pane"
    exit 0
  fi

  # TOGGLE IN: Need to join agent pane or switch to it
  if ! agent_window_exists; then
    if pinvim_win=$(locate_pinvim_window); then
      move_to_agent_window "$pinvim_win"
    else
      create_agent_window
    fi
  fi

  # Decide: split (nvim) or switch (shell)
  if is_nvim_running; then
    save_state "split"
    local agent_idx
    agent_idx=$(get_agent_window_idx)
    tmux join-pane -h -s "${agent_idx}.1" -l 40%
  else
    save_state "direct:${CURRENT_WINDOW_IDX}"
    local agent_idx
    agent_idx=$(get_agent_window_idx)
    tmux select-window -t "$agent_idx"
  fi
}

main "$@"
