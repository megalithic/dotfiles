#!/bin/bash

set -euo pipefail

# -- set some useful vars for executable info:
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename ${__file} .sh)"
__root="$(cd "$(dirname "${__dir}")" && pwd)"
# shellcheck disable=SC2034,SC2015
__invocation="$(printf %q "${__file}")$( (($#)) && printf ' %q' "$@" || true)"

pushd "$XDG_DATA_HOME/src" && echo "-> cd ~/.local/share/src successful";

update() {
  cd "$XDG_DATA_HOME/src/neovim" && echo "-> cd neovim successful";
  git checkout master && echo "-> git checkout master successful";
  git fetch && echo "-> git fetch successful";
}

clone() {
  if [[ ! -d "$XDG_DATA_HOME/src/neovim" ]]; then
    git clone git@github.com:neovim/neovim.git && echo "-> git clone neovim successful";
    cd neovim && echo "-> cd neovim successful";
    # do it all and then exit cleanly...
    update && build && popd && exit 0;
  fi
}

do_build() {
  git up && echo "-> git up successful";
  [[ -d "$XDG_DATA_HOME/src/neovim/.deps" ]] && sudo rm -rf "$XDG_DATA_HOME/src/neovim/.deps" && echo "-> remove .deps successful" || exit 1;
  make CMAKE_BUILD_TYPE=RelWithDebInfo || exit 1 && echo "-> make successful";
  sudo make install || exit 1 && echo "-> make install successful";
}

build() {
  if [[ $(git rev-parse HEAD) == $(git rev-parse @{u}) ]]; then
    echo "-> neovim already up to date on origin/master; skipping."
  else
    read -p "[?] Build neovim from source (Y/n)? " yn
    case $yn in
      [Yy]* )
        do_build || exit 1
        ;;
      "" )
        do_build || exit 1 # default
        ;;
      [Nn]* )
        echo "-> skipping neovim install"
        ;;
      * )
        echo "Please answer [y]es or [n]o."
        echo ""
        exec $__invocation
        ;;
    esac
  fi
}

clone && update && build && popd;
