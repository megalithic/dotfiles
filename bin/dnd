#!/usr/bin/env bash

#
# What in tarnation?
#
# CLI tool to control macOS/notification center do-not-disturb (DND) mode
# REF: https://gist.github.com/a7madgamal/9d3518a62c21477a92be461fbd652533#file-change-do-not-disturb-dnd-setting-on-macos-big-sur-using-the-terminal-md
#

command="$(basename "$0")"

help() {
  printf -- "Usage: "$command" <subcommand> [options]\n"
  printf -- "Subcommands:\n"
  printf -- "    on       Turn ON do-not-disturb (DND) mode\n"
  printf -- "    off      Turn OFF do-not-disturb (DND) mode\n"
  printf -- "    toggle   Toggle do-not-disturb (DND) mode ON and OFF\n"
  printf -- "    status   Get the current status of do-not-disturb (DND) mode\n"
}

nc_pref="$HOME/Library/Preferences/ByHost/com.apple.notificationcenterui"
# nc_pref=$(fd notificationcenterui $HOME/Library/Preferences/ByHost)

on() {
  sleep 1
  defaults -currentHost write "$nc_pref" doNotDisturb -boolean true
  defaults -currentHost write "$nc_pref" doNotDisturbDate -date "`date -u +\"%Y-%m-%d %H:%M:%S +0000\"`"
  killall NotificationCenter
}

off() {
  defaults -currentHost write "$nc_pref" doNotDisturb -boolean false
  killall NotificationCenter
}

toggle() {
  if $(dnd_enabled); then
    off
  else
    on
  fi

  status
}

dnd_enabled() {
  dnd_enabled=$(defaults -currentHost read "$nc_pref" doNotDisturb)
  $([[ "$dnd_enabled" -eq 1 ]] && true || false)
}

status() {
  # echo "nc_pref -> $nc_pref"

  if $(dnd_enabled); then
    echo "DND: on"
  else
    echo "DND: off"
  fi
}

subcommand=$1
case $subcommand in
  '')
    toggle ;;
  '-h' | '--help')
    help ;;
  *)
    shift
    ${subcommand} $@
    ;;
esac
