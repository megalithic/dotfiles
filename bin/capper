#!/usr/bin/env zsh

# TODO: setup certbot and own cdn domain with digital-ocean:
# https://www.digitalocean.com/community/tutorials/how-to-use-certbot-standalone-mode-to-retrieve-let-s-encrypt-ssl-certificates-on-ubuntu-1804

# Source environment variables from agenix (required for Hammerspoon context)
ENV_VARS_PATH="$(getconf DARWIN_USER_TEMP_DIR)/agenix/env-vars"
if [[ -f "$ENV_VARS_PATH" ]]; then
  source "$ENV_VARS_PATH"
fi

# Ensure nix binaries are in PATH (required for Hammerspoon context)
export PATH="/etc/profiles/per-user/$USER/bin:/run/current-system/sw/bin:$PATH"

if [ ! -n "$1" ]; then
  echo "Usage: $0 [file]"
  return
fi

file="$1"
friendly=$(echo "$1" | sed -e "s#$HOME/_screenshots/##g" \
  -e 's/^cap_//' \
  -e 's/-\([0-9]\{4\}\)\.png$/_\1.png/' \
  -e 's/T/_/' \
  -e 's/://g' \
  -e 's/-//g')

s3cmd --access_key="$DO_SPACES_CAPS_KEY" \
  --secret_key="$DO_SPACES_CAPS_SECRET" \
  --host="${DO_SPACES_CAPS_REGION}.digitaloceanspaces.com" \
  --host-bucket='%(bucket)s.'"${DO_SPACES_CAPS_REGION}"'.digitaloceanspaces.com' \
  -P put "$file" "s3://${DO_SPACES_CAPS_SPACE}/screenshots/$friendly"

if [ "$?" -ne 0 ]; then
  echo "There was a problem uploading '$file' to 's3://${DO_SPACES_CAPS_SPACE}/screenshots/$friendly'"

  exit 1
else
  echo "${DO_SPACES_CAPS_CDN_URL}/screenshots/$friendly"
fi
