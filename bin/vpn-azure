#!/usr/bin/env bash
# LaunchDeck VPN CLI wrapper for OpenVPN
# Connects to LaunchDeck Azure VPN Gateway via OpenVPN

set -euo pipefail

readonly SCRIPT_NAME="$(basename "$0")"
readonly CONFIG_FILE="${AGENIX_VPN_CONFIG:-$HOME/.config/vpn/launchdeck-inline.ovpn}"
readonly PID_FILE="/tmp/launchdeck-vpn.pid"
readonly LOG_FILE="/tmp/launchdeck-vpn.log"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME [COMMAND]

Commands:
  connect, c, start, s     Connect to LaunchDeck VPN
  disconnect, d, stop      Disconnect from LaunchDeck VPN
  status, st               Show VPN connection status
  logs, l                  Show VPN connection logs
  help, h                  Show this help message

Examples:
  $SCRIPT_NAME connect
  $SCRIPT_NAME c
  $SCRIPT_NAME status
  $SCRIPT_NAME disconnect

Environment:
  Config: $CONFIG_FILE
  PID:    $PID_FILE
  Logs:   $LOG_FILE
EOF
}

log_info() {
  echo -e "${GREEN}✓${NC} $*"
}

log_warn() {
  echo -e "${YELLOW}⚠${NC} $*"
}

log_error() {
  echo -e "${RED}✗${NC} $*" >&2
}

notify() {
  local title="$1"
  local message="$2"
  local urgency="${3:-normal}"

  if command -v ntfy &>/dev/null; then
    ntfy send -t "$title" -m "$message" -u "$urgency" 2>/dev/null || true
  fi
}

check_openvpn() {
  if ! command -v openvpn &>/dev/null; then
    log_error "OpenVPN is not installed or not in PATH"
    log_info "Add to home/packages.nix: pkgs.openvpn"
    log_info "Then run: sudo darwin-rebuild switch --flake ./"
    exit 1
  fi
}

check_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    log_error "Config file not found: $CONFIG_FILE"
    exit 1
  fi
}

is_running() {
  if [[ -f "$PID_FILE" ]]; then
    local pid
    pid=$(cat "$PID_FILE")
    if ps -p "$pid" &>/dev/null; then
      return 0
    else
      # Stale PID file
      rm -f "$PID_FILE"
      return 1
    fi
  fi
  return 1
}

get_vpn_ip() {
  ifconfig | grep -A 4 "utun" | grep "inet " | awk '{print $2}' | grep "^100\.99\.252\." | head -1 || echo ""
}

cmd_connect() {
  check_openvpn
  check_config

  if is_running; then
    log_warn "VPN is already connected"
    cmd_status
    return 0
  fi

  log_info "Connecting to LaunchDeck VPN..."
  log_warn "You will be prompted for:"
  log_warn "  1. Your sudo password (for OpenVPN)"
  log_warn "  2. Your Azure AD credentials (email + MFA)"
  echo

  # Start OpenVPN in background with logging
  sudo openvpn --config "$CONFIG_FILE" \
    --daemon \
    --log "$LOG_FILE" \
    --writepid "$PID_FILE"

  # Wait for connection (check for up to 30 seconds)
  local attempts=0
  local max_attempts=30

  while [[ $attempts -lt $max_attempts ]]; do
    if is_running; then
      local vpn_ip
      vpn_ip=$(get_vpn_ip)
      if [[ -n "$vpn_ip" ]]; then
        log_info "Connected! VPN IP: $vpn_ip"
        notify "LaunchDeck VPN" "Connected: $vpn_ip" "normal"
        return 0
      fi
    else
      log_error "OpenVPN process died. Check logs:"
      log_error "  tail -50 $LOG_FILE"
      notify "LaunchDeck VPN" "Connection failed" "high"
      return 1
    fi

    sleep 1
    ((attempts++))
  done

  log_warn "Connection in progress (still establishing)..."
  log_info "Check status with: $SCRIPT_NAME status"
  log_info "Check logs with: $SCRIPT_NAME logs"
}

cmd_disconnect() {
  if ! is_running; then
    log_warn "VPN is not connected"
    return 0
  fi

  local pid
  pid=$(cat "$PID_FILE")

  log_info "Disconnecting from LaunchDeck VPN..."
  sudo kill "$pid" 2>/dev/null || true

  # Wait for process to die
  local attempts=0
  while ps -p "$pid" &>/dev/null && [[ $attempts -lt 10 ]]; do
    sleep 0.5
    ((attempts++))
  done

  rm -f "$PID_FILE"
  log_info "Disconnected"
  notify "LaunchDeck VPN" "Disconnected" "normal"
}

cmd_status() {
  if is_running; then
    local pid
    pid=$(cat "$PID_FILE")
    local vpn_ip
    vpn_ip=$(get_vpn_ip)

    log_info "Status: ${GREEN}Connected${NC}"
    echo "  PID:    $pid"
    if [[ -n "$vpn_ip" ]]; then
      echo "  VPN IP: $vpn_ip"
    else
      echo "  VPN IP: (still establishing...)"
    fi
    echo "  Config: $CONFIG_FILE"
    echo "  Logs:   $LOG_FILE"
    return 0
  else
    log_warn "Status: Disconnected"
    return 1
  fi
}

cmd_logs() {
  if [[ ! -f "$LOG_FILE" ]]; then
    log_warn "No log file found at: $LOG_FILE"
    return 1
  fi

  tail -50 "$LOG_FILE"
}

# Main command dispatcher
main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    connect|c|start|s)
      cmd_connect "$@"
      ;;
    disconnect|d|stop)
      cmd_disconnect "$@"
      ;;
    status|st)
      cmd_status "$@"
      ;;
    logs|l)
      cmd_logs "$@"
      ;;
    help|h|-h|--help)
      usage
      exit 0
      ;;
    *)
      log_error "Unknown command: $command"
      echo
      usage
      exit 1
      ;;
  esac
}

main "$@"
