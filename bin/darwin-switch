#!/usr/bin/env bash
# Workaround for darwin-rebuild hanging on setupLaunchAgents
#
# The hang occurs when darwin-rebuild runs home-manager activation via:
#   launchctl asuser $(id -u) sudo -u $USER --set-home /nix/store/.../activation-$USER
#
# This pattern can intermittently hang during the setupLaunchAgents step,
# likely due to launchd timing/race conditions when rapidly calling
# launchctl bootout/bootstrap.
#
# This script works around the issue by:
# 1. Building the darwin configuration
# 2. Running the darwin activate script with HM activation patched out
# 3. Running home-manager activation directly (not via launchctl asuser)

set -euo pipefail

cd ~/.dotfiles

HOST="${1:-megabookpro}"
USERNAME="${2:-seth}"

echo "━━━ Building darwin configuration for $HOST..."
nix build ".#darwinConfigurations.$HOST.system" -o /tmp/darwin-result

echo ""
echo "━━━ Activating darwin system (patching out home-manager activation)..."

# Create a patched activate script that skips HM activation
# The HM activation line looks like:
#   launchctl asuser "$(id -u $USER)" sudo -u $USER --set-home /nix/store/.../activation-$USER
ACTIVATE_SCRIPT="/tmp/darwin-result/activate"
PATCHED_SCRIPT="/tmp/darwin-activate-patched"

# Patch out the launchctl asuser line that runs home-manager activation
sed 's|^launchctl asuser.*activation-'"$USERNAME"'$|echo "Skipping home-manager activation (will run separately)"|' \
    "$ACTIVATE_SCRIPT" > "$PATCHED_SCRIPT"
chmod +x "$PATCHED_SCRIPT"

# Run patched darwin activation as root
sudo "$PATCHED_SCRIPT"

# Update the system profile (normally done by darwin-rebuild switch)
# Set HOME to root's home to avoid warning about ownership
sudo HOME=/var/root nix-env -p /nix/var/nix/profiles/system --set /tmp/darwin-result

echo ""
echo "━━━ Activating home-manager directly (as user)..."
# Run the same activation script that darwin would run, but directly
# This avoids the launchctl asuser wrapper that can cause hangs
HM_ACTIVATION=$(grep -o '/nix/store/[^/]*-activation-'"$USERNAME" "$ACTIVATE_SCRIPT" | head -1)
if [[ -n "$HM_ACTIVATION" && -x "$HM_ACTIVATION" ]]; then
    export HOME_MANAGER_BACKUP_EXT=hm-backup
    "$HM_ACTIVATION"
else
    echo "Warning: Could not find home-manager activation script, running from built package..."
    nix build ".#darwinConfigurations.$HOST.config.home-manager.users.$USERNAME.home.activationPackage" -o /tmp/hm-result
    /tmp/hm-result/activate
fi

echo ""
echo "━━━ Post-activation health checks..."

# Check for stuck launchd services (agenix, home-manager related)
# A stuck service has "-" for PID and non-zero exit code, or "spawn scheduled" state
STUCK_SERVICES=()
while IFS= read -r line; do
    pid=$(echo "$line" | awk '{print $1}')
    exit_code=$(echo "$line" | awk '{print $2}')
    name=$(echo "$line" | awk '{print $3}')
    
    # Skip if running (has PID) or exited successfully
    if [[ "$pid" == "-" && "$exit_code" != "0" ]]; then
        STUCK_SERVICES+=("$name (exit: $exit_code)")
    fi
done < <(launchctl list 2>/dev/null | grep -E "(agenix|nix-community|home\.|nh-clean)" || true)

if [[ ${#STUCK_SERVICES[@]} -gt 0 ]]; then
    echo "⚠ Found potentially stuck services:"
    for svc in "${STUCK_SERVICES[@]}"; do
        echo "  - $svc"
    done
    echo ""
    echo "Attempting to restart stuck services..."
    for svc in "${STUCK_SERVICES[@]}"; do
        svc_name=$(echo "$svc" | cut -d' ' -f1)
        echo "  Kickstarting $svc_name..."
        launchctl kickstart -k "gui/$(id -u)/$svc_name" 2>/dev/null || true
    done
    sleep 2
    echo "  Done."
else
    echo "✓ All launchd services healthy"
fi

# Verify agenix secrets are accessible
AGENIX_DIR="$(getconf DARWIN_USER_TEMP_DIR 2>/dev/null)/agenix"
if [[ -d "$AGENIX_DIR" && -f "$AGENIX_DIR/env-vars" ]]; then
    echo "✓ Agenix secrets accessible"
else
    echo "⚠ Agenix secrets not found, kickstarting service..."
    launchctl kickstart -k "gui/$(id -u)/org.nix-community.home.activate-agenix" 2>/dev/null || true
    sleep 2
    if [[ -f "$AGENIX_DIR/env-vars" ]]; then
        echo "  ✓ Agenix secrets now accessible"
    else
        echo "  ✗ Agenix secrets still not accessible - check manually"
    fi
fi

echo ""
echo "✓ Done! System and home-manager activated successfully."

# Send notification via ntfy
if command -v ntfy >/dev/null 2>&1; then
    ntfy send -t "Nix Darwin" -m "✓ System rebuild completed successfully"
fi
