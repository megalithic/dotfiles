#!/bin/zsh

if [[ -z $XDG_DATA_HOME ]]; then
  export XDG_DATA_HOME="$HOME/.local/share"
fi
if [[ -z $XDG_CONFIG_HOME ]]; then
  export XDG_CONFIG_HOME="$HOME/.config"
fi

source "${HOME}/.dotfiles/config/zsh/lib/helpers.zsh"

# set -euo pipefail

# -- set some useful vars for executable info:
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename "$__file" .sh)"
__root="$(cd "$(dirname "$__dir")" && pwd)"
# shellcheck disable=SC2034,SC2015
__invocation="$(printf %q "$__file")$( (($#)) && printf ' %q' "$@" || true)"

REPO="${1:-}"
TAG="${2:-}"

if [ -z "${REPO}" ]; then
  log_error "missing repo argument; halting"
  exit 1
fi

LS_NAME="$(echo "$REPO" | awk -F/ '{print $(NF)}')"
LSPS_PATH="${XDG_DATA_HOME}/lsp"
LS_PATH="${LSPS_PATH}/${LS_NAME}"
TMP_PATH="$HOME/tmp"
mkdir -p "$LS_PATH"

TARGET=""
BINARY=""
BUILD_TYPE=""

get_binary_name() {
  local ls_name="${1:-}"
  local bin=""

  case "$ls_name" in
  'postgres-language-server')
    bin="postgrestools_aarch64-apple-darwin"
    ;;

  *)
    bin="${ls_name}" || "${LS_NAME}"
    ;;

  esac

  echo "$bin"
}

do_install() {

  rm -rf "$LS_PATH" && log "deleted existing ${LS_NAME} from ${LS_PATH}.."

  case "$TAG" in
  '')
    TARGET="https://github.com/${REPO}/releases/latest/download"
    BINARY="${LS_NAME}.zip"
    BUILD_TYPE="archive"
    ;;
  *)
    TARGET="https://github.com/${REPO}/releases/download/${TAG}"
    BINARY="$(get_binary_name ${LS_NAME})"
    BUILD_TYPE="tag_unzip"
    ;;
  esac

  if [[ $BUILD_TYPE == "tag_unzip" ]]; then

    #FIXME: if this is a binary an dnot an archive, let's chmod it and move it to our lsp/bin folder, otherwise, unzip it and leave the unziped dir in our lsp/ folder
    # example of one that is a binary directly, not an archive to unzip
    # for this, we can do: `file -b --mime-type postgrestools_aarch64-apple-darwin | sed 's|/.*||'`, which would result in "application"
    # curl -L https://github.com/supabase-community/postgres-language-server/releases/download/${TAG}/postgrestools_aarch64-apple-darwin -o ${XDG_DATA_HOME}/lsp/bin/postgrestools
    log "downloading and unpacking $TARGET/$BINARY to ${TMP_PATH}/${LS_NAME}.."

    cd "$TMP_PATH" &&
      (
        curl -fLO -o "$TMP_PATH/$BINARY" "$TARGET/$BINARY" &&
          (tar -xvzf "$BINARY" -C "$LSPS_PATH" && log_ok "unpacked $TARGET/$BINARY to $LSPS_PATH") &&
          mv "$LSPS_PATH/$TAG" "$LS_PATH" &&
          (rm "$BINARY" && log_ok "removed $TMP_PATH/$BINARY")
      ) && log_ok "finished downloading and unzipping $REPO ($TAG) to $LS_PATH" ||
      exit 1

    # curl -fLO "$TARGET/$BINARY" > "$TMP_PATH/$BINARY"
    # #&&
    # #  (tar -xvzf "$TMP_PATH/$BINARY" -C "$LSPS_PATH" && log_ok "unpacked $TMP_PATH/$BINARY to $LSPS_PATH")
    # #&&
    # # mv "$LSPS_PATH/$LS_NAME" "$LS_PATH" &&
    # # (rm "$BINARY" && log_ok "removed $TMP_PATH/$BINARY") && log_ok "finished downloading and unzipping $REPO ($TAG) to $LS_PATH" ||
    # # exit 1
  else
    log_warn "$BUILD_TYPE not yet supported."
  fi
}

do_install || exit 1
