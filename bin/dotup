#!/usr/bin/env zsh

echo '

================================================================================

    ┌┬┐┌─┐┌─┐┌─┐┬  ┬┌┬┐┬ ┬┬┌─┐
    │││├┤ │ ┬├─┤│  │ │ ├─┤││   :: dots & things
    ┴ ┴└─┘└─┘┴ ┴┴─┘┴ ┴ ┴ ┴┴└─┘
    @megalithic

    Setting up dotfiles. If the ~/.dotfiles folder does not exist, it will be
    cloned from https://github.com/megalithic/dotfiles.

================================================================================
'

pause()
{
  echo "$*"; read -k1 -s
}

# Detect OS
if [[ -z $PLATFORM ]]
then
  # unamestr=`uname`
  platform="unknown"

  if [[ "$(uname)" == "Darwin" ]]; then
    platform="macos"
  elif [[ "$(expr substr $(uname -s) 1 5)" == "Linux" ]]; then
    platform="linux"
  elif [[ "$(expr substr $(uname -s) 1 5)" == 'FreeBSD' ]]; then
    platform='freebsd'
  elif [[ "$(expr substr $(uname -s) 1 10)" == "MINGW32_NT" ]]; then
    platform="windows"
  fi

  export PLATFORM=$platform
  
  echo ":: setting PLATFORM to $platform"
fi


# PRIVATES export exists?
if [[ -z $PRIVATES ]]
then
  export PRIVATES=$DOTS/private
  export PRIVATE=$DOTS/private
fi

# DOTDIR export exists?
if [[ -z $DOTS ]]
then
  export DOTS="$HOME/.dotfiles"
  export DOTDIR="$HOME/.dotfiles"
  export DIRDOTS="$HOME/.dotfiles"
fi

# git exists?
if (( $+commands[git] )); then
  echo ":: git already installed"
else
  echo ":: git not installed; requires xcode to continue.. install xcode? [y]"
  read answer

  if [[ $answer == [yY] ]]
  then
    echo ":: installing xcode"
    xcode-select --install
  fi
fi

# ~/.dotfiles dir exists?
if [[ ! -d $DOTS ]]
then
  echo ":: cloning dotfiles..."
  mkdir -p $DOTS
  git clone --recursive git://github.com/megalithic/dotfiles.git "$DOTS"
else
  if [[ -z $SKIP_DOTFILES_UPDATE ]]
  then
    echo ":: ~/.dotfiles found; updating to latest.."
    cd $DOTS
    git add -u .
    git stash
    git pull --recurse-submodules --rebase origin master
    git push origin master
    git stash pop
    cd $HOME
  fi
fi

# Install Homebrew
if (( $+commands[brew] )); then
  echo ":: brew already installed"
else
  echo ":: brew not found; installing Homebrew..."
  /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

echo ":: brewing all the things..."
export HOMEBREW_CASK_OPTS="--appdir=/Applications"
brew update

pause ":: in order to install MAS apps, you must manually signin to the Apple App Store; press <space> to continue.."
brew bundle --file=$DOTS/homebrew/Brewfile

# echo ":: doing post-brew things..."
# sudo xcodebuild -license accept
# ln -sfv /usr/local/bin/gcc-4.9 /usr/local/bin/gcc

if [[ -a $DOTS/homebrew/Brewfile.local ]]
then
  echo ":: brewing private/local things..."
  # brew "private"/"local" Brewfile
  brew bundle --file=$DOTS/homebrew/Brewfile.local
fi

# Link $DOTS/bin files to $HOME/.bin
#echo ":: symlinking $DOTS/bin files to $HOME/.bin/..."
#mkdir -p $HOME/.bin
#rm -f $HOME/.bin/*
#for found in $DOTS/bin/*; do
#  source="$DOTS/$found"
#  dest="$HOME/.bin/`basename \"${found%.*}\"`"
#
#  ln -sf $source $dest
#  echo ":: symlinked binary $source to $dest"
#done

# Run generic installers
$DOTS/bin/generic

# Run platform-based installers (macos, linux, windows, freebsd)
$DOTS/bin/platform

# Symlink all the things
$DOTS/bin/symlinks

# Setup private repo and things
$DOTS/bin/private

echo ":: changing your shell to brewed zsh..."
zsh_path=$(which zsh)
echo ":: attempting to set $zsh_path as your zsh path in /etc/shells"
grep -Fxq "$zsh_path" /etc/shells || sudo bash -c "echo $zsh_path >> /etc/shells"
chsh -s "$zsh_path" $USER
zsh

# Print Manual Instructions
echo "\n\nATTENTION! Further Instructions:\n"

echo "  * Set ZShell as your login shell"
echo "    - run \`chsh\`"
echo "    - enter your password"
echo "    - type '/bin/zsh' at the prompt"

# zsh:foldenable:foldmethod=marker:ft=zsh;ts=2;sts=2;sw=2
