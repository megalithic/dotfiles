#!/usr/bin/env bash

#
# What in tarnation is this?
#
# CLI tool to control slack status and presence
#
# slack [options] [STATUS_NAME | FUZZY_PATTERN]
#
# Running `slack` with no argument will let you fuzzy-find pre-defined statuses
#
# Dependencies:
#   Required: various ENV variables (see source below)
#   Optional: `spinner` from my dotfiles' bin dir
#

set -euo pipefail

# trap 'clean_exit $? $LINENO' EXIT
# trap ctrl_c INT # trap ctrl-c and call ctrl_c()

# function clean_exit {
# 	set +x
# 	if [[ $1 != "0" ]]; then
# 		printf -- "FATAL error code %s occurred on line %s" "$1" "$2"
# 	fi
# }

# -- set some useful vars for executable info:
__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
__file="${__dir}/$(basename "${BASH_SOURCE[0]}")"
__base="$(basename ${__file} .sh)"
__root="$(cd "$(dirname "${__dir}")" && pwd)"
# shellcheck disable=SC2034,SC2015
__invocation="$(printf %q "${__file}")$( (($#)) && printf ' %q' "$@" || true)"

POPUP="false"
VERBOSE="false"
DEBUG="false"

# -- ENV vars
AWAY_CHAN_ID=${OUTSTAND_AWAY_CHAN_ID:-}
SLACK_TOKEN=${OUTSTAND_TOKEN:-}
SLACK_USER=${OUTSTAND_USER:-}

# -- internal vars
request=""
api_url="https://slack.com/api"
presence=""
profile=""
dnd=""
away_text=""
spinner_path="$HOME/.dotfiles/bin/spinner"
statuses="away
lunch
coffee
dog
errand
pair
zoom
meeting
dnd
focus
back
here
"

# -- checks for needed dependencies
(command -v fzf &>/dev/null) && FZF_FOUND="installed" || FZF_FOUND="not installed"
[[ -x "$spinner_path" ]] && SPINNER_FOUND="installed" || SPINNER_FOUND="not installed"

[[ $SPINNER_FOUND == "installed" ]] && spinner="$spinner_path" || spinner="echo '.'"

function __help() {
	printf -- "Usage: %s [options] [STATUS | FUZZY_PATTERN]\n" "$__base"
	printf -- "\n"
  printf -- "   Statuses:\n"
	printf -- "     away              Set presence to away, and profile for being gone\n"
	printf -- "     lunch             Set presence to away, and profile for lunch\n"
	printf -- "     coffee            Set presence to away, and profile for coffee\n"
	printf -- "     dog               Set presence to away, and profile for dog walking\n"
	printf -- "     errand            Set presence to away, and profile for running errand\n"
	printf -- "     pair              Set DND to on, and profile for pairing\n"
	printf -- "     zoom              Set DND to on, and profile for zoom/meeting\n"
	printf -- "     dnd               Set DND to on, and profile for DND/focus\n"
	printf -- "     focus             Set DND to on, and profile for DND/focus\n"
	printf -- "     back              Set presence to auto, and profile accordingly\n"
	printf -- "     here              Set presence to auto, and profile accordingly\n"
	printf -- "\n"
	printf -- "   Options:\n"
	printf -- "     -p                Run fzf normally for tmux' popup feature, else fzf-tmux\n"
	printf -- "     -h                This help text you're presently reading. üòÑ\n"
	printf -- "\n"
	printf -- "   Dependencies:\n"
	printf -- "     fzf               ($FZF_FOUND)\n"
	printf -- "     spinner           ($SPINNER_FOUND)\n"
	printf -- "\n"
}

function __info() {
	printf -- "%s executation details:\n" "$__base"
	printf -- "---------------------------------------------------\n"
	printf -- "fzf:          %s\n" "$fzf_cmd"
	printf -- "curl:         %s\n" "$curl_cmd"
	printf -- "\n"
	printf -- "cwd:          %s\n" "$__dir"
	printf -- "filepath:     %s\n" "$__file"
	printf -- "basename:     %s\n" "$__base"
	printf -- "root:         %s\n" "$__root"
	printf -- "invocation:   %s\n" "$__invocation"
	printf -- "\n"
}

# -- halt if we don't have FZF installed
if [[ $FZF_FOUND == "not installed" ]]; then
	printf -- "ERROR: %s requires FZF to be installed" "$__base"
	__help
	exit 1
fi

while getopts "phdv" OPTION; do
	case $OPTION in

		p)
			POPUP="true"
			shift
			;;

		h)
			__help
			break
			;;

		d)
			DEBUG="true"
			shift
			;;

		v)
			VERBOSE="true"
			shift
			;;

	esac
done

# -- first param passed in, after options
status="${1:-}"

# -- handle options
[[ $VERBOSE == "true" || $DEBUG == "true" ]] && curl_cmd="curl --verbose" || curl_cmd="curl --silent"
[[ $POPUP == "true" ]] && fzf_cmd="fzf" || fzf_cmd="fzf-tmux"

function request() {
  local feature=$1
  local options=$2

  # TODO: use -d / --data for building the request
	if [[ -n $options && $options != 0 ]]; then
    #  1>&2
    request="$curl_cmd -S --data "token=$SLACK_TOKEN" "$api_url/$feature?$options""
	else
    request="$curl_cmd -S --data "token=$SLACK_TOKEN" "$api_url/$feature""
	fi

  [[ $VERBOSE == "true" || $DEBUG == "true" ]] && echo "executing request: $request"

  if [[ $DEBUG == "true" ]]; then
    exec $request | $spinner || {
      echo 'failed to make slack request'
      exit 1
    }
  else
    exec $request &>/dev/null | $spinner || {
      echo 'failed to make slack request'
      exit 1
    }
  fi
}

function set_profile() {
  local profile="$1"
	request "users.profile.set" "$profile"
}

function set_presence() {
  local presence="$1"
	request "users.setPresence" "$presence"
}

function set_dnd() {
  local dnd="$1"
	request "dnd.setSnooze" "$dnd"
}

function end_dnd() {
  local dnd="$1"
	request "dnd.endDnd" "$dnd"
}

function set_away_chan_text() {
  local away_text="$1"
	request "chat.postMessage?channel=$AWAY_CHAN_ID&as_user=$SLACK_USER&text=$away_text" 0
}


function away() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22..afk..%22,%22status_emoji%22:%22:afk:%22%7D"
	set_profile $profile

  set_away_chan_text "bbl"
}

function brb() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22..be%20right%20back..%22,%22status_emoji%22:%22:brb:%22%7D"
	set_profile $profile

  set_away_chan_text "brb"
}

function lunch() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22..lunch..%22,%22status_emoji%22:%22:taco:%22%7D"
	set_profile $profile

  set_away_chan_text "bbl,%20lunch"
}

function errand() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22..running%20an%20errand..%22,%22status_emoji%22:%22:car:%22%7D"
	set_profile $profile

  set_away_chan_text "bbl,%20running%20an%20errand"
}

function coffee() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22..covfefe..%22,%22status_emoji%22:%22:coffee:%22%7D"
	set_profile $profile

  set_away_chan_text "brb,%20coffee"
}

function dog() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22...walking%20the%20puppers..%22,%22status_emoji%22:%22:doge:%22%7D"
	set_profile $profile

  set_away_chan_text "bbiab,%20walking%20the%20puppers"
}

function gone() {
	presence="presence=away"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22%22,%22status_emoji%22:%22%22%7D"
	set_profile $profile

	dnd="num_minutes=930"
	set_dnd $dnd

  set_away_chan_text "üëã%20have%20a%20good%20one!"
}

function pair() {
	profile="profile=%7B%22status_text%22:%22..pairing..%22,%22status_emoji%22:%22:pear:%22%7D"
	set_profile $profile

	dnd="num_minutes=120"
	set_dnd $dnd
}

function zoom() {
	profile="profile=%7B%22status_text%22:%22..on%20a%20call..%22,%22status_emoji%22:%22:calendar:%22%7D"
	set_profile $profile

	dnd="num_minutes=120"
	set_dnd $dnd
}

function dnd() {
	profile="profile=%7B%22status_text%22:%22..focused%20work%20time..%22,%22status_emoji%22:%22:octagonal_sign:%22%7D"
	set_profile $profile

	dnd="num_minutes=120"
	set_dnd $dnd
}

function here() {
	presence="presence=auto"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22%22,%22status_emoji%22:%22%22%7D"
	set_profile $profile

	dnd=0
	end_dnd $dnd
}

function back() {
	presence="presence=auto"
	set_presence $presence

	profile="profile=%7B%22status_text%22:%22%22,%22status_emoji%22:%22%22%7D"
	set_profile $profile

	dnd=0
	end_dnd $dnd

  set_away_chan_text "back"
}

function log() {
  local given_status="$1"
  printf "\n[%s] at %s... \r\n" "$given_status" "$(date)"
}

function do_status() {
  local given_status="$1"

  ${given_status} "$@"
  log "$given_status"

  exit 0
}

[[ $VERBOSE == "true" || $DEBUG == "true" ]] && __info

# if we pass in a status, use it directly
if [[ $status ]]; then
  do_status "$status"
else
  # finally, just fuzzy-find based upon our supported statuses
  selected_status="$(echo "$statuses" | $fzf_cmd --reverse --exit-0 --prompt="Ôíê select slack status ÔÅî " --header="ÔÜò supported slack statuses" --bind="enter:replace-query+print-query")"
  [[ -n "$selected_status" ]] && do_status "$selected_status" || return
fi
